#usage:
# curl -s http://127.0.0.1:9609/blocked
# curl -s http://127.0.0.1:9609/check?ip=94.67.184.196
# curl -s http://127.0.0.1:9609/unblock?ip=94.67.184.196


# Local-only admin vhost (no TLS). Access only from 127.0.0.1 / ::1.
server {
    listen 127.0.0.1:9609;
    listen [::1]:9609;
    server_name localhost;

    access_log off;
#    error_log  /var/log/nginx/antiddos-admin.error.log warn;

    # HARD BLOCK anything not local (belt + suspenders)
    allow 127.0.0.1;
    allow ::1;
    deny all;

    default_type text/plain;

    # List blocked IPs (shared dict)
    location = /blocked {
        content_by_lua_block {
            local dict = ngx.shared.antiddos_blocked
            if not dict then
                ngx.say("antiddos_blocked dict not found")
                return
            end

            local keys = dict:get_keys(0) -- 0 = all keys
            ngx.say("blocked_count\t", #keys)
            for _, ip in ipairs(keys) do
                local v = dict:get(ip)
                ngx.say(ip, "\t", tostring(v))
            end
        }
    }

    # Check one IP:
    # curl 'http://127.0.0.1:9609/check?ip=1.2.3.4'
    location = /check {
        content_by_lua_block {
            local ip = ngx.var.arg_ip
            if not ip or ip == "" then
                ngx.say("usage: /check?ip=1.2.3.4")
                return
            end

            local dict = ngx.shared.antiddos_blocked
            local v = dict and dict:get(ip)
            if v then
                ngx.say(ip, " BLOCKED: ", tostring(v))
            else
                ngx.say(ip, " NOT blocked")
            end
        }
    }

    # (Optional) Unblock an IP:
    # curl 'http://127.0.0.1:9609/unblock?ip=1.2.3.4'
    location = /unblock {
        content_by_lua_block {
            local ip = ngx.var.arg_ip
            if not ip or ip == "" then
                ngx.say("usage: /unblock?ip=1.2.3.4")
                return
            end

            local dict = ngx.shared.antiddos_blocked
            if not dict then
                ngx.say("antiddos_blocked dict not found")
                return
            end

            dict:delete(ip)
            ngx.say("unblocked: ", ip)
        }
    }
}
